!function(e,t){"object"==typeof exports&&exports&&"string"!=typeof exports.nodeName?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):(e.brutusin={},t(e.brutusin))}(this,function BrutusinFactory(brutusin){String.prototype.startsWith||(String.prototype.startsWith=function(e,t){return t=t||0,this.indexOf(e,t)===t}),String.prototype.endsWith||(String.prototype.endsWith=function(e,t){var n=this.toString();(void 0===t||t>n.length)&&(t=n.length),t-=e.length;var r=n.indexOf(e,t);return-1!==r&&r===t}),String.prototype.includes||(String.prototype.includes=function(){"use strict";return-1!==String.prototype.indexOf.apply(this,arguments)}),String.prototype.format||(String.prototype.format=function(){for(var e=this,t=0;t<arguments.length;t++){var n=new RegExp("\\{"+t+"\\}","gi");e=e.replace(n,arguments[t])}return e});var BrutusinForms=new Object;BrutusinForms.messages={validationError:"Validation error",required:"This field is **required**",invalidValue:"Invalid field value",addpropNameExistent:"This property is already present in the object",addpropNameRequired:"A name is required",minItems:"At least `{0}` items are required",maxItems:"At most `{0}` items are allowed",pattern:"Value does not match pattern: `{0}`",minLength:"Value must be **at least** `{0}` characters long",maxLength:"Value must be **at most** `{0}` characters long",multipleOf:"Value must be **multiple of** `{0}`",minimum:"Value must be **greater or equal than** `{0}`",exclusiveMinimum:"Value must be **greater than** `{0}`",maximum:"Value must be **lower or equal than** `{0}`",exclusiveMaximum:"Value must be **lower than** `{0}`",minProperties:"At least `{0}` properties are required",maxProperties:"At most `{0}` properties are allowed"},BrutusinForms.decorators=new Array,BrutusinForms.addDecorator=function(e){BrutusinForms.decorators[BrutusinForms.decorators.length]=e},BrutusinForms.onResolutionStarted=function(e){},BrutusinForms.onResolutionFinished=function(e){},BrutusinForms.onValidationError=function(e,t){e.focus(),e.className.includes(" error")||(e.className+=" error"),alert(t)},BrutusinForms.onValidationSuccess=function(e){e.className=e.className.replace(" error","")},BrutusinForms.postRender=null,BrutusinForms.instances=new Array,BrutusinForms.create=function(schema){function validateDepencyMapIsAcyclic(){function e(t,n,r){if(n.hasOwnProperty(r))return void(error="Schema dependency graph has cycles");if(n[r]=null,!t.hasOwnProperty(r)){t[r]=null;var a=dependencyMap[r];if(a)for(var i=0;i<a.length;i++)e(t,n,a[i]);delete n[r]}}var t=new Object;for(var n in dependencyMap)t.hasOwnProperty(n)||e(t,new Object,n)}function appendChild(e,t,n){e.appendChild(t);for(var r=0;r<BrutusinForms.decorators.length;r++)BrutusinForms.decorators[r](t,n)}function createPseudoSchema(e){var t=new Object;for(var n in e)"items"!==n&&"properties"!==n&&"additionalProperties"!==n&&("pattern"===n?t[n]=new RegExp(e[n]):t[n]=e[n]);return t}function populateSchemaMap(e,t){var n=createPseudoSchema(t);if(schemaMap[e]=n,"object"===t.type){if(t.properties){n.properties=new Object;for(var r in t.properties){var a=e+"."+r;n.properties[r]=a,populateSchemaMap(a,t.properties[r])}}if(t.additionalProperties){var a=e+"[*]";n.additionalProperties=a,t.additionalProperties.hasOwnProperty("type")?populateSchemaMap(a,t.additionalProperties):populateSchemaMap(a,SCHEMA_ANY)}}else if("array"===t.type)n.items=e+"[#]",populateSchemaMap(n.items,t.items);else if(t.hasOwnProperty("oneOf")){n.oneOf=new Array,n.type="oneOf";for(var i in t.oneOf){var a=e+"."+i;n.oneOf[i]=a,populateSchemaMap(a,t.oneOf[i])}}if(t.hasOwnProperty("dependsOn")){null===t.dependsOn&&(t.dependsOn=["$"]);for(var o=new Array,i=0;i<t.dependsOn.length;i++)t.dependsOn[i]?t.dependsOn[i].startsWith("$")?o[i]=t.dependsOn[i]:e.endsWith("]")?o[i]=e+"."+t.dependsOn[i]:o[i]=e.substring(0,e.lastIndexOf("."))+"."+t.dependsOn[i]:o[i]="$";schemaMap[e].dependsOn=o;for(var i=0;i<o.length;i++){var u=dependencyMap[o[i]];u||(u=new Array,dependencyMap[o[i]]=u),u[u.length]=e}}}function renderTitle(e,t,n){if(e&&t){var r=document.createElement("label");"any"!==n.type&&"object"!==n.type&&"array"!==n.type&&(r.htmlFor=getInputId());var a=document.createTextNode(t+":");if(appendChild(r,a,n),n.description&&(r.title=n.description),n.required){var i=document.createElement("sup");appendChild(i,document.createTextNode("*"),n),appendChild(r,i,n),r.className="required"}appendChild(e,r,n)}}function getInputId(){return formId+"_"+inputCounter}function validate(e){var t=!0;if(e.hasOwnProperty("getValidationError")){var n=e.getValidationError();n?(BrutusinForms.onValidationError(e,n),t=!1):BrutusinForms.onValidationSuccess(e)}if(e.childNodes)for(var r=0;r<e.childNodes.length;r++)validate(e.childNodes[r])||(t=!1);return t}function clear(e){if(e)for(;e.firstChild;)e.removeChild(e.firstChild)}function render(e,t,n,r,a,i){var o=getSchemaId(n),u=getSchema(o);renderInfoMap[o]=new Object,renderInfoMap[o].titleContainer=e,renderInfoMap[o].container=t,renderInfoMap[o].parentObject=r,renderInfoMap[o].propertyProvider=a,renderInfoMap[o].value=i,clear(e),clear(t);var s=renderers[u.type];s&&!u.dependsOn&&(u.title?renderTitle(e,u.title,u):a&&renderTitle(e,a.getValue(),u),i||(i="undefined"!=typeof initialValue&&null!==initialValue?getInitialValue(n):u["default"]),s(t,n,r,a,i))}function createPropertyProvider(e,t){var n=new Object;return n.getValue=e,n.onchange=t,n}function getInitialValue(id){var ret;try{eval("ret = initialValue"+id.substring(1))}catch(e){ret=null}return ret}function getValue(schema,input){if("function"==typeof input.getValue)return input.getValue();var value;return value=schema["enum"]?input.options[input.selectedIndex].value:input.value,""===value?null:("integer"===schema.type?(value=parseInt(value),isFinite(value)||(value=null)):"number"===schema.type?(value=parseFloat(value),isFinite(value)||(value=null)):"boolean"===schema.type?(value=input.checked,value||(value=!1)):"any"===schema.type&&value&&eval("value="+value),value)}function getSchemaId(e){return e.replace(/\["[^"]*"\]/g,"[*]").replace(/\[\d*\]/g,"[#]")}function getSchema(e){return schemaMap[e]}function onDependecyChanged(e,t){function n(e){for(var t in schemaMap)e.startsWith(t)&&delete schemaMap[t]}function r(e){var t=new Expression(e);t.visit(data,function(e,t,n){delete t[n]})}var a=dependencyMap[e];if(a&&obj.schemaResolver){var i=function(e){if(e)for(var a in e)if(JSON.stringify(schemaMap[a])!==JSON.stringify(e[a])){n(a),r(a),populateSchemaMap(a,e[a]);var i=renderInfoMap[a];i&&render(i.titleContainer,i.container,a,i.parentObject,i.propertyProvider,i.value)}BrutusinForms.onResolutionFinished(t)};BrutusinForms.onResolutionStarted(t),obj.schemaResolver(a,obj.getData(),i)}}function Expression(e){function t(e){if(null===e)return null;for(var t=new Array,n=null,r=0,a=0;a<e.length;a++)'"'===e.charAt(a)?null===n?n='"':'"'===n&&(n=null,t[t.length]=e.substring(r,a+1).trim(),r=a+1):"'"===e.charAt(a)?null===n?n="'":"'"===n&&(n=null,t[t.length]=e.substring(r,a+1).trim(),r=a+1):"["===e.charAt(a)?null===n&&(r!==a&&(t[t.length]=e.substring(r,a).trim()),t[t.length]="[",r=a+1):"]"===e.charAt(a)?null===n&&(r!==a&&(t[t.length]=e.substring(r,a).trim()),t[t.length]="]",r=a+1):"."===e.charAt(a)?null===n&&(r!==a&&(t[t.length]=e.substring(r,a).trim()),r=a+1):a===e.length-1&&(t[t.length]=e.substring(r,a+1).trim());return t}(null===e||0===e.length||"."===e)&&(e="$");for(var n=new Array,r=t(e),a=!1,i=0,o="",u=0;u<r.length;u++){var s=r[u];if("["===s){if(a)throw"Error parsing expression '"+e+"': Nested [ found";a=!0,i=0,o+=s}else if("]"===s){if(!a)throw"Error parsing expression '"+e+"': Unbalanced ] found";a=!1,o+=s,n[n.length]=o,o=""}else if(a){if(i>0)throw"Error parsing expression '"+e+"': Multiple tokens found inside a bracket";o+=s,i++}else n[n.length]=s;if(u===r.length-1&&a)throw"Error parsing expression '"+e+"': Unbalanced [ found"}this.exp=e,this.queue=n,this.visit=function(e,t){function n(e,r,a,i,o){if(null!=a){var u=r.shift();if("$"===u){e="$";var u=r.shift()}if(u)if(Array.isArray(a)){if(!u.startsWith("["))throw"Node '"+e+"' is of type array";var s=u.substring(1,u.length-1);if(s.equals("#"))for(var l=0;l<a.length;l++){var d=a[l];n(e+u,r.slice(0),d,a,l),n(e+"["+l+"]",r.slice(0),d,a,l)}else if("$"===s){var d=a[a.length-1];n(e+u,r.slice(0),d,a,a.length-1)}else{var c=parseInt(s);if(isNaN(c))throw"Element '"+s+"' of node '"+e+"' is not an integer, or the '$' last element symbol,  or the wilcard symbol '#'";if(0>c)throw"Element '"+s+"' of node '"+e+"' is lower than zero";var d=a[c];n(e+u,r.slice(0),d,a,c)}}else{if("object"!=typeof a)throw"boolean"==typeof a||"number"==typeof a||"string"==typeof a?"Node is leaf but still are tokens remaining: "+u:"Node type '"+typeof a+"' not supported for index field '"+e+"'";if("[*]"===u)for(var p in a){var d=a[p];n(e+u,r.slice(0),d,a,p),n(e+'["'+p+'"]',r.slice(0),d,a,p)}else{var d;if(u.startsWith("[")){var s=u.substring(1,u.length-1);if(!s.startsWith('"')&&!s.startsWith("'"))throw"Element '"+s+"' of node '"+e+"' must be a string expression or wilcard '*'";s=s.substring(1,s.length()-1),e+=u,d=a[s]}else e=e.length>0?e+"."+u:u,d=a[u];n(e,r,d,a,u)}}else t(a,i,o)}}n(this.exp,this.queue,e)}}var SCHEMA_ANY={type:"any"},obj=new Object,schemaMap=new Object,dependencyMap=new Object,renderInfoMap=new Object,container,data,error,initialValue,inputCounter=0,formId="BrutusinForms#"+BrutusinForms.instances.length;populateSchemaMap("$",schema),validateDepencyMapIsAcyclic();var renderers=new Object;return renderers.integer=function(e,t,n,r,a){renderers.string(e,t,n,r,a)},renderers.number=function(e,t,n,r,a){renderers.string(e,t,n,r,a)},renderers.any=function(e,t,n,r,a){renderers.string(e,t,n,r,a)},renderers.string=function(e,t,n,r,a){var i,o=getSchemaId(t),u=getSchema(o);if("any"===u.type)i=document.createElement("textarea"),a&&(i.value=JSON.stringify(a,null,4));else if(u["enum"]){if(i=document.createElement("select"),!u.required){var s=document.createElement("option"),l=document.createTextNode("");s.value="",appendChild(s,l,u),appendChild(i,s,u)}for(var d=0,c=0;c<u["enum"].length;c++){var s=document.createElement("option"),l=document.createTextNode(u["enum"][c]);s.value=u["enum"][c],appendChild(s,l,u),appendChild(i,s,u),a&&u["enum"][c]===a&&(d=c,u.required||d++)}i.selectedIndex=d}else i=document.createElement("input"),"integer"===u.type||"number"===u.type?(i.type="number",i.step="any","number"!=typeof a&&(a=null)):"email"===u.format?i.type="email":i.type="text",null!==a&&"undefined"!=typeof a&&(i.value=a);return i.schema=o,i.setAttribute("autocorrect","off"),i.getValidationError=function(){try{var e=getValue(u,i);if(null===e){if(u.required)return BrutusinForms.messages.required}else{if(u.pattern&&!u.pattern.test(e))return BrutusinForms.messages.pattern.format(u.pattern.source);if(u.minLength&&(!e||u.minLength>e.length))return BrutusinForms.messages.minLength.format(u.minLength);if(u.maxLength&&e&&u.maxLength<e.length)return BrutusinForms.messages.maxLength.format(u.maxLength)}if(null!==e&&!isNaN(e)){if(u.multipleOf&&e%u.multipleOf!==0)return BrutusinForms.messages.multipleOf.format(u.multipleOf);if(u.hasOwnProperty("maximum")){if(u.exclusiveMaximum&&e>=u.maximum)return BrutusinForms.messages.exclusiveMaximum.format(u.maximum);if(!u.exclusiveMaximum&&e>u.maximum)return BrutusinForms.messages.maximum.format(u.maximum)}if(u.hasOwnProperty("minimum")){if(u.exclusiveMinimum&&e<=u.minimum)return BrutusinForms.messages.exclusiveMinimum.format(u.minimum);if(!u.exclusiveMinimum&&e<u.minimum)return BrutusinForms.messages.minimum.format(u.minimum)}}}catch(t){return BrutusinForms.messages.invalidValue}},i.onchange=function(){var e;try{e=getValue(u,i)}catch(t){e=null}n?n[r.getValue()]=e:data=e,onDependecyChanged(o,i)},u.description&&(i.title=u.description,i.placeholder=u.description),i.onchange(),i.id=getInputId(),inputCounter++,appendChild(e,i,u),n},renderers["boolean"]=function(e,t,n,r,a){var i=getSchemaId(t),o=getSchema(i),u=document.createElement("input");u.type="checkbox",u.schema=i,u.onchange=function(){n?n[r.getValue()]=getValue(o,u):data=getValue(o,u),onDependecyChanged(i,u)},a===!0&&(u.checked=!0),u.id=getInputId(),inputCounter++,o.description&&(u.title=o.description),u.onchange(),appendChild(e,u,o)},renderers.oneOf=function(e,t,n,r,a){var i=getSchemaId(t),o=getSchema(i),u=document.createElement("select"),s=document.createElement("div");s.innerHTML="",u.type="select",u.schema=i;var l=document.createElement("option");l.value=null,appendChild(u,l,o);for(var d=0;d<o.oneOf.length;d++){var c=document.createElement("option"),p=t+"."+d,m=getSchema(p),h=document.createTextNode(m.title);c.value=o.oneOf[d],appendChild(c,h,o),appendChild(u,c,o)}u.onchange=function(){render(null,s,t+"."+(u.selectedIndex-1),n,r,a)},appendChild(e,u,o),appendChild(e,s,o)},renderers.object=function(e,t,n,r,a){function i(e){var t=new Object;return t.getValue=function(){return e},t.onchange=function(e){},t}function o(e,t,n,r,a){var i=getSchemaId(n),o=getSchema(i),u=t.tBodies[0],s=document.createElement("tr"),l=document.createElement("td");l.className="add-prop-name";var d=document.createElement("table"),c=document.createElement("tr"),p=document.createElement("td"),m=document.createElement("td"),h="$"+Object.keys(e).length+"$",f=document.createElement("td");f.className="prop-value";var g=document.createElement("input");g.type="text",g.getValidationError=function(){return g.previousValue!==g.value&&e.hasOwnProperty(g.value)?BrutusinForms.messages.addpropNameExistent:g.value?void 0:BrutusinForms.messages.addpropNameRequired};var v=createPropertyProvider(function(){return g.value?g.value:h},function(t){v.getValue()!==t&&(t||(t=h),t&&e.hasOwnProperty(t)&&(e[v.getValue()]=e[t],delete e[t]))});g.onblur=function(){if(g.previousValue!==g.value){for(var t=g.value,n=1;g.previousValue!==t&&e.hasOwnProperty(t);)t=g.value+"("+n+")",n++;return g.value=t,v.onchange(g.previousValue),void(g.previousValue=g.value)}};var y=document.createElement("button");y.setAttribute("type","button"),y.className="remove",appendChild(y,document.createTextNode("x"),o),y.onclick=function(){delete e[g.value],t.deleteRow(s.rowIndex),g.value=null,v.onchange(g.previousValue)},appendChild(p,g,o),appendChild(m,y,o),appendChild(c,p,o),appendChild(c,m,o),appendChild(d,c,o),appendChild(l,d,o),appendChild(s,l,o),appendChild(s,f,o),appendChild(u,s,o),appendChild(t,u,o),render(null,f,n,e,v,a),r&&(g.value=r,g.onblur())}var u=getSchemaId(t),s=getSchema(u),l=new Object;n?(r.getValue()||0===r.getValue())&&(n[r.getValue()]=l):data=l;var d=document.createElement("table");d.className="object";var c=document.createElement("tbody");appendChild(d,c,s);var p=0;if(s.hasOwnProperty("properties")){p=s.properties.length;for(var m in s.properties){var h=document.createElement("tr"),f=document.createElement("td");f.className="prop-name";var g=t+"."+m,v=document.createElement("td");v.className="prop-value",appendChild(c,h,s),appendChild(h,f,s),appendChild(h,v,s);var y=i(m),b=null;a&&(b=a[m]),render(f,v,g,l,y,b)}}if(s.additionalProperties){var x=getSchema(s.additionalProperties),w=document.createElement("div");appendChild(w,d,s);var C=document.createElement("button");if(C.setAttribute("type","button"),C.onclick=function(){o(l,d,t+"[*]")},(s.maxProperties||s.minProperties)&&(C.getValidationError=function(){return s.minProperties&&p+d.rows.length<s.minProperties?BrutusinForms.messages.minProperties.format(s.minProperties):s.maxProperties&&p+d.rows.length>s.maxProperties?BrutusinForms.messages.maxProperties.format(s.maxProperties):void 0}),x.description&&(C.title=x.description),appendChild(C,document.createTextNode("Add"),s),appendChild(w,C,s),a)for(var O in a)s.properties.hasOwnProperty(O)||o(l,d,t+'["'+m+'"]',O,a[O]);appendChild(e,w,s)}else appendChild(e,d,s)},renderers.array=function(e,t,n,r,a){function i(e,t,n,r){var a=getSchemaId(n),i=getSchema(a),o=document.createElement("tbody"),u=document.createElement("tr");u.className="item";var s=document.createElement("td");s.className="item-index";var l=document.createElement("td");l.className="item-action";var d=document.createElement("td");d.className="item-value";var c=document.createElement("button");c.setAttribute("type","button"),c.className="remove",appendChild(c,document.createTextNode("x"),i);var p=function(){for(var e=0;e<t.rows.length;e++){var n=t.rows[e];n.cells[0].innerHTML=e+1}};c.onclick=function(){e.splice(u.rowIndex,1),t.deleteRow(u.rowIndex),p()},appendChild(l,c,i);var m=document.createTextNode(t.rows.length+1);appendChild(s,m,i),appendChild(u,s,i),appendChild(u,l,i),appendChild(u,d,i),appendChild(o,u,i),appendChild(t,o,i);var h=createPropertyProvider(function(){return u.rowIndex});render(null,d,n,e,h,r)}var o=getSchemaId(t),u=getSchema(o),s=getSchema(u.items),l=new Array;n?(r.getValue()||0===r.getValue())&&(n[r.getValue()]=l):data=l,r&&(r.onchange=function(e){delete n[e],n[r.getValue()]=l});var d=document.createElement("div"),c=document.createElement("table");c.className="array",appendChild(d,c,u),appendChild(e,d,u);var p=document.createElement("button");if(p.setAttribute("type","button"),p.getValidationError=function(){return u.minItems&&u.minItems>c.rows.length?BrutusinForms.messages.minItems.format(u.minItems):u.maxItems&&u.maxItems<c.rows.length?BrutusinForms.messages.maxItems.format(u.maxItems):void 0},p.onclick=function(){i(l,c,t+"[#]",null)},s.description&&(p.title=s.description),appendChild(p,document.createTextNode("Add item"),u),appendChild(d,c,u),appendChild(d,p,u),a&&a instanceof Array)for(var m=0;m<a.length;m++)i(l,c,t+"["+m+"]",a[m]);appendChild(e,d,u)},obj.render=function(e,t){container=e,initialValue=t;var n=document.createElement("form");if(n.className="brutusin-form",n.onsubmit=function(e){return!1},container?appendChild(container,n):appendChild(document.body,n),error){var r=document.createElement("label"),a=document.createTextNode(error);appendChild(r,a),r.className="error-message",appendChild(n,r)}else render(null,n,"$",null,null);rendered=!0,dependencyMap.hasOwnProperty("$")&&onDependecyChanged("$"),BrutusinForms.postRender&&BrutusinForms.postRender(obj)},obj.getRenderingContainer=function(){return container},obj.validate=function(){return validate(container)},obj.getData=function(){function e(t){if(t instanceof Array){if(0===t.length)return null;for(var n=new Array,r=0;r<t.length;r++)n[r]=e(t[r]);return n}if(""===t)return null;if(t instanceof Object){var n=new Object;for(var a in t)if(!a.startsWith("$")||!a.endsWith("$")){var i=e(t[a]);null!==i&&(n[a]=i)}return n}return t}return container?e(data):null},BrutusinForms.instances[BrutusinForms.instances.length]=obj,obj},brutusin["json-forms"]=BrutusinForms});